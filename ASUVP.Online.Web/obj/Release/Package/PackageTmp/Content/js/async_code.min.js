function CertificateAdjuster(){}function CheckForPlugIn_Async(){function t(t,i){if(typeof i=="string")return-1;var r=t.split("."),u=!0;cadesplugin.async_spawn(function*(){var e;yield i.MajorVersion==parseInt(r[0])?yield i.MinorVersion==parseInt(r[1])?yield i.BuildVersion==parseInt(r[2])?u=!0:yield i.BuildVersion<parseInt(r[2])&&(u=!1):yield i.MinorVersion<parseInt(r[1])&&(u=!1):yield i.MajorVersion<parseInt(r[0])&&(u=!1);u||(document.getElementById("PluginEnabledImg").setAttribute("src","Img/yellow_dot.png"),document.getElementById("PlugInEnabledTxt").innerHTML="Плагин загружен, но есть более свежая версия.");document.getElementById("PlugInVersionTxt").innerHTML="Версия плагина: "+yield n.toString();var f=yield cadesplugin.CreateObjectAsync("CAdESCOM.About"),t=yield f.CSPVersion("",75),o=yield t.MajorVersion+"."+yield t.MinorVersion+"."+yield t.BuildVersion;document.getElementById("CSPVersionTxt").innerHTML="Версия криптопровайдера: "+o;try{e=yield f.CSPName(75);document.getElementById("CSPNameTxt").innerHTML="Криптопровайдер: "+e}catch(s){}return})}function i(n){var i=getXmlHttp();i.open("GET","//cryptopro.ru/sites/default/files/products/cades/latest_2_0.txt",!0);i.onreadystatechange=function(){var r;i.readyState==4&&i.status==200&&(r=i.responseText,t(r,n))};i.send(null)}document.getElementById("PlugInEnabledTxt").innerHTML="Плагин загружен.";var n;cadesplugin.async_spawn(function*(){var t=yield cadesplugin.CreateObjectAsync("CAdESCOM.About");n=yield t.PluginVersion;i(n);location.pathname.indexOf("symalgo_sample.html")>=0?(FillCertList_Async("CertListBox1"),FillCertList_Async("CertListBox2")):FillCertList_Async("CertListBox")})}function FillCertList_Async(n){cadesplugin.async_spawn(function*(){var i=yield cadesplugin.CreateObjectAsync("CAdESCOM.Store"),e,o,s,h,u,t,f,c;if(!i){alert("store failed");return}try{yield i.Open()}catch(r){alert("Ошибка при открытии хранилища: "+cadesplugin.getLastError(r));return}if(e=document.getElementById(n),e){try{s=yield i.Certificates;o=yield s.Count}catch(r){h=document.getElementById("boxdiv").style.display="";return}if(o==0){h=document.getElementById("boxdiv").style.display="";return}for(u=1;u<=o;u++){try{t=yield s.Item(u)}catch(r){alert("Ошибка при перечислении сертификатов: "+cadesplugin.getLastError(r));return}f=document.createElement("OPTION");c=new Date;try{var l=new Date(yield t.ValidToDate),a=new Date(yield t.ValidFromDate),v=yield t.IsValid(),y=yield v.Result;if(c<l&&yield t.HasPrivateKey()&&y)f.text=(new CertificateAdjuster).GetCertInfoString(yield t.SubjectName,a);else continue}catch(r){alert("Ошибка при получении свойства SubjectName: "+cadesplugin.getLastError(r))}try{f.value=yield t.Thumbprint}catch(r){alert("Ошибка при получении свойства Thumbprint: "+cadesplugin.getLastError(r))}e.options.add(f)}yield i.Close()}})}function CreateSimpleSign_Async(){cadesplugin.async_spawn(function*(){var e,u,t,o,f,a,s,h,v,n,i,c,y;try{e=yield cadesplugin.CreateObjectAsync("CAdESCOM.Store");yield e.Open()}catch(r){alert("Failed to create CAdESCOM.Store: "+r.number);return}if(u=yield e.Certificates,yield u.Count==0){n=document.getElementById("boxdiv").style.display="";return}for(o=0,f=1;f<=yield u.Count;f++){try{t=yield u.Item(f)}catch(l){alert("Ошибка при перечислении сертификатов: "+cadesplugin.getLastError(l));return}a=new Date;try{var p=new Date(yield t.ValidToDate),w=yield t.IsValid(),b=yield w.Result;if(a<p&&yield t.HasPrivateKey()&&b){o=1;break}else continue}catch(l){alert("Ошибка при получении свойства SubjectName: "+cadesplugin.getLastError(l))}}if(o==0){n=document.getElementById("boxdiv").style.display="";return}s=document.getElementById("DataToSignTxtBox").value;h=document.getElementsByName("SignatureTitle");try{FillCertInfo_Async(t);n="";try{i=yield cadesplugin.CreateObjectAsync("CAdESCOM.CPSigner")}catch(r){n="Failed to create CAdESCOM.CPSigner: "+r.number;throw n;}if(i)yield i.propset_Certificate(t);else{n="Failed to create CAdESCOM.CPSigner";throw n;}if(c=yield cadesplugin.CreateObjectAsync("CAdESCOM.CadesSignedData"),y=1,s){yield c.propset_Content(s);yield i.propset_Options(1);try{v=yield c.SignCades(i,y)}catch(r){n="Не удалось создать подпись из-за ошибки: "+cadesplugin.getLastError(r);throw n;}}document.getElementById("SignatureTxtBox").innerHTML=v;h[0].innerHTML="Подпись сформирована успешно:"}catch(r){h[0].innerHTML="Возникла ошибка:";document.getElementById("SignatureTxtBox").innerHTML=r}})}function SignCadesBES_Async(n,t,i){cadesplugin.async_spawn(function*(n){var p=document.getElementById(n[0]),w=p.selectedIndex,b,c,k,l,a,o,v,d,r,u,s,g,y,h,f;if(w==-1){alert("Select certificate");return}b=p.options[w].value.split(" ").reverse().join("").replace(/\s/g,"").toUpperCase();try{c=yield cadesplugin.CreateObjectAsync("CAdESCOM.Store");yield c.Open()}catch(e){alert("Failed to create CAdESCOM.Store: "+e.number);return}if(k=yield c.Certificates,l=yield k.Find(cadesplugin.CAPICOM_CERTIFICATE_FIND_SHA1_HASH,b),yield l.Count==0){alert("Certificate not found");return}a=yield l.Item(1);o=document.getElementById("DataToSignTxtBox").value;typeof t!="undefined"&&(o=Base64.encode(t));v=document.getElementsByName("SignatureTitle");try{FillCertInfo_Async(a);r="";try{u=yield cadesplugin.CreateObjectAsync("CAdESCOM.CPSigner")}catch(e){r="Failed to create CAdESCOM.CPSigner: "+e.number;throw r;}if(s=yield cadesplugin.CreateObjectAsync("CADESCOM.CPAttribute"),yield s.propset_Name(cadesplugin.CAPICOM_AUTHENTICATED_ATTRIBUTE_SIGNING_TIME),g=new Date,yield s.propset_Value(g),y=yield u.AuthenticatedAttributes2,yield y.Add(s),h=yield cadesplugin.CreateObjectAsync("CADESCOM.CPAttribute"),yield h.propset_Name(cadesplugin.CADESCOM_AUTHENTICATED_ATTRIBUTE_DOCUMENT_NAME),yield h.propset_Value("Document Name"),yield y.Add(h),u)yield u.propset_Certificate(a);else{r="Failed to create CAdESCOM.CPSigner";throw r;}if(f=yield cadesplugin.CreateObjectAsync("CAdESCOM.CadesSignedData"),o){yield u.propset_Options(cadesplugin.CAPICOM_CERTIFICATE_INCLUDE_WHOLE_CHAIN);yield f.propset_ContentEncoding(cadesplugin.CADESCOM_BASE64_TO_BINARY);typeof i!="undefined"&&yield f.propset_DisplayData(1);yield f.propset_Content(o);try{d=yield f.SignCades(u,cadesplugin.CADESCOM_CADES_BES)}catch(e){r="Не удалось создать подпись из-за ошибки: "+cadesplugin.getLastError(e);throw r;}}document.getElementById("SignatureTxtBox").innerHTML=d;v[0].innerHTML="Подпись сформирована успешно:"}catch(e){v[0].innerHTML="Возникла ошибка:";document.getElementById("SignatureTxtBox").innerHTML=e}},n)}function SignCadesBES_Async_File(n){cadesplugin.async_spawn(function*(n){var l=document.getElementById(n[0]),a=l.selectedIndex,v,e,o,s,p,t,i,u,w,b,h,f,k,g,nt;if(a==-1){alert("Select certificate");return}v=l.options[a].value.split(" ").reverse().join("").replace(/\s/g,"").toUpperCase();try{e=yield cadesplugin.CreateObjectAsync("CAdESCOM.Store");yield e.Open()}catch(r){alert("Failed to create CAdESCOM.Store: "+r.number);return}var tt=yield e.Certificates,y=yield tt.Find(0,v);if(yield y.Count==0){alert("Certificate not found");return}o=yield y.Item(1);s=document.getElementsByName("SignatureTitle");try{FillCertInfo_Async(o);t="";try{i=yield cadesplugin.CreateObjectAsync("CAdESCOM.CPSigner")}catch(r){t="Failed to create CAdESCOM.CPSigner: "+r.number;throw t;}if(u=yield cadesplugin.CreateObjectAsync("CADESCOM.CPAttribute"),w=0,yield u.propset_Name(w),b=new Date,yield u.propset_Value(b),h=yield i.AuthenticatedAttributes2,yield h.Add(u),f=yield cadesplugin.CreateObjectAsync("CADESCOM.CPAttribute"),k=1,yield f.propset_Name(k),yield f.propset_Value("Document Name"),yield h.Add(f),i)yield i.propset_Certificate(o);else{t="Failed to create CAdESCOM.CPSigner";throw t;}var c=yield cadesplugin.CreateObjectAsync("CAdESCOM.CadesSignedData"),d=Base64.encode(fileContent);if(d){yield c.propset_ContentEncoding(1);yield c.propset_Content(d);yield i.propset_Options(1);try{g=Date.now();p=yield c.SignCades(i,1);nt=Date.now();document.getElementsByName("TimeTitle")[0].innerHTML="Время выполнения: "+(nt-g)+" мс"}catch(r){t="Не удалось создать подпись из-за ошибки: "+cadesplugin.getLastError(r);throw t;}}document.getElementById("SignatureTxtBox").innerHTML=p;s[0].innerHTML="Подпись сформирована успешно:"}catch(r){s[0].innerHTML="Возникла ошибка:";document.getElementById("SignatureTxtBox").innerHTML=r}},n)}function SignCadesXLong_Async(n){cadesplugin.async_spawn(function*(n){var f=document.getElementById(n[0]),e=f.selectedIndex,o,u,t,i;if(e==-1){alert("Select certificate");return}o=f.options[e].value.split(" ").reverse().join("").replace(/\s/g,"").toUpperCase();try{u=yield cadesplugin.CreateObjectAsync("CAdESCOM.Store");yield u.Open()}catch(r){alert("Failed to create CAdESCOM.Store: "+r.number);return}var y=yield u.Certificates,s=yield y.Find(0,o);if(yield s.Count==0){alert("Certificate not found");return}var h=yield s.Item(1),c=document.getElementById("DataToSignTxtBox").value,l=document.getElementsByName("SignatureTitle"),a;try{FillCertInfo_Async(h);t="";try{i=yield cadesplugin.CreateObjectAsync("CAdESCOM.CPSigner")}catch(r){t="Failed to create CAdESCOM.CPSigner: "+r.number;throw t;}if(i)yield i.propset_Certificate(h);else{t="Failed to create CAdESCOM.CPSigner";throw t;}var v=yield cadesplugin.CreateObjectAsync("CAdESCOM.CadesSignedData"),p=document.getElementById("TSPServiceTxtBox").value;if(c){yield v.propset_Content(c);yield i.propset_Options(1);yield i.propset_TSAAddress(p);try{a=yield v.SignCades(i,93)}catch(r){t="Не удалось создать подпись из-за ошибки: "+cadesplugin.getLastError(r);throw t;}}document.getElementById("SignatureTxtBox").innerHTML=a;l[0].innerHTML="Подпись сформирована успешно:"}catch(r){l[0].innerHTML="Возникла ошибка:";document.getElementById("SignatureTxtBox").innerHTML=r}},n)}function SignCadesXML_Async(n){cadesplugin.async_spawn(function*(n){var c=document.getElementById(n[0]),l=c.selectedIndex,a,o,t,u,b;if(l==-1){alert("Select certificate");return}a=c.options[l].value.split(" ").reverse().join("").replace(/\s/g,"").toUpperCase();try{o=yield cadesplugin.CreateObjectAsync("CAdESCOM.Store");yield o.Open()}catch(r){alert("Failed to create CAdESCOM.Store: "+r.number);return}var k=yield o.Certificates,v=yield k.Find(0,a);if(yield v.Count==0){alert("Certificate not found");return}var s=yield v.Item(1),y=document.getElementById("DataToSignTxtBox").value,p=document.getElementsByName("SignatureTitle"),w;try{FillCertInfo_Async(s);t="";try{u=yield cadesplugin.CreateObjectAsync("CAdESCOM.CPSigner")}catch(r){t="Failed to create CAdESCOM.CPSigner: "+r.number;throw t;}if(u)yield u.propset_Certificate(s);else{t="Failed to create CAdESCOM.CPSigner";throw t;}var i=yield cadesplugin.CreateObjectAsync("CAdESCOM.SignedXML"),f="",e="",d=yield s.PublicKey(),g=yield d.Algorithm,h=yield g.Value;if(h=="1.2.643.7.1.1.1.1")f="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34102012-gostr34112012-256",e="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34112012-256";else if(h=="1.2.643.7.1.1.1.2")f="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34102012-gostr34112012-512",e="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34112012-512";else if(h=="1.2.643.2.2.19")f="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34102001-gostr3411",e="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr3411";else{t="Данная демо страница поддерживает XML подпись сертификатами с алгоритмом ГОСТ Р 34.10-2012, ГОСТ Р 34.10-2001";throw t;}if(b=0,y){yield i.propset_Content(y);yield i.propset_SignatureType(b);yield i.propset_SignatureMethod(f);yield i.propset_DigestMethod(e);try{w=yield i.Sign(u)}catch(r){t="Не удалось создать подпись из-за ошибки: "+cadesplugin.getLastError(r);throw t;}}document.getElementById("SignatureTxtBox").innerHTML=w;p[0].innerHTML="Подпись сформирована успешно:"}catch(r){p[0].innerHTML="Возникла ошибка:";document.getElementById("SignatureTxtBox").innerHTML=r}},n)}function FillCertInfo_Async(n,t){var i,r;typeof t=="undefined"?(i="cert_info",r=""):(i=t,r=t);cadesplugin.async_spawn(function*(n){var t=new CertificateAdjuster,i,r;document.getElementById(n[1]).style.display="";document.getElementById(n[2]+"subject").innerHTML="Владелец: <b>"+t.GetCertName(yield n[0].SubjectName)+"<b>";document.getElementById(n[2]+"issuer").innerHTML="Издатель: <b>"+t.GetIssuer(yield n[0].IssuerName)+"<b>";document.getElementById(n[2]+"from").innerHTML="Выдан: <b>"+t.GetCertDate(yield n[0].ValidFromDate);+ "<b>";document.getElementById(n[2]+"till").innerHTML="Действителен до: <b>"+t.GetCertDate(yield n[0].ValidToDate)+"<b>";var u=yield n[0].PublicKey(),f=yield u.Algorithm,e=yield f.FriendlyName;document.getElementById(n[2]+"algorithm").innerHTML="Алгоритм ключа: <b>"+e+"<b>";i=yield n[0].PrivateKey;r=yield i.ProviderName;document.getElementById(n[2]+"provname").innerHTML="Криптопровайдер: <b>"+r+"<b>"},n,i,r)}function Encrypt_Async(){cadesplugin.async_spawn(function*(){var t,i,o,u,r,e,n,y,p;if(document.getElementById("DataEncryptedIV1").innerHTML="",document.getElementById("DataEncryptedIV2").innerHTML="",document.getElementById("DataEncryptedDiversData1").innerHTML="",document.getElementById("DataEncryptedDiversData2").innerHTML="",document.getElementById("DataEncryptedBox1").innerHTML="",document.getElementById("DataEncryptedBox2").innerHTML="",document.getElementById("DataEncryptedKey1").innerHTML="",document.getElementById("DataEncryptedKey2").innerHTML="",document.getElementById("DataDecryptedBox1").innerHTML="",document.getElementById("DataDecryptedBox2").innerHTML="",t=document.getElementById("CertListBox1"),i=t.selectedIndex,i==-1){alert("Select certificate");return}u=t.options[i].value.split(" ").reverse().join("").replace(/\s/g,"").toUpperCase();try{o=yield cadesplugin.CreateObjectAsync("CAdESCOM.Store");yield o.Open()}catch(f){alert("Failed to create CAdESCOM.Store: "+f.number);return}var c=0,l=yield o.Certificates,r=yield l.Find(c,u);if(yield r.Count==0){alert("Certificate not found");return}var a=yield r.Item(1),t=document.getElementById("CertListBox2"),i=t.selectedIndex;if(i==-1){alert("Select certificate");return}if(u=t.options[i].value.split(" ").reverse().join("").replace(/\s/g,"").toUpperCase(),r=yield l.Find(c,u),yield r.Count==0){alert("Certificate not found");return}var v=yield r.Item(1),w=Base64.encode(document.getElementById("DataToEncrTxtBox1").value),b=Base64.encode(document.getElementById("DataToEncrTxtBox2").value);try{FillCertInfo_Async(a,"cert_info1");FillCertInfo_Async(v,"cert_info2");e="";try{n=yield cadesplugin.CreateObjectAsync("cadescom.symmetricalgorithm")}catch(f){e="Failed to create cadescom.symmetricalgorithm: "+f;alert(e);throw e;}yield n.GenerateKey();var s=yield n.DiversifyKey(),k=yield s.DiversData,d=yield s.IV,g=yield s.Encrypt(w,1);document.getElementById("DataEncryptedDiversData1").innerHTML=k;document.getElementById("DataEncryptedIV1").innerHTML=d;document.getElementById("DataEncryptedBox1").innerHTML=g;var h=yield n.DiversifyKey(),nt=yield h.DiversData,tt=yield h.IV,it=yield h.Encrypt(b,1);document.getElementById("DataEncryptedDiversData2").innerHTML=nt;document.getElementById("DataEncryptedIV2").innerHTML=tt;document.getElementById("DataEncryptedBox2").innerHTML=it;y=yield n.ExportKey(a);document.getElementById("DataEncryptedKey1").innerHTML=y;p=yield n.ExportKey(v);document.getElementById("DataEncryptedKey2").innerHTML=p;alert("Данные зашифрованы успешно:")}catch(f){alert("Ошибка при шифровании данных:"+f);throw"Ошибка при шифровании данных:"+f;}})}function Decrypt_Async(n){cadesplugin.async_spawn(function*(t){var f,e,c,o,y,u,i,p,w,s,b,k,d,h,g;if(document.getElementById("DataDecryptedBox1").innerHTML="",document.getElementById("DataDecryptedBox2").innerHTML="",f=document.getElementById(t[0]),e=f.selectedIndex,e==-1){alert("Select certificate");return}c=f.options[e].value.split(" ").reverse().join("").replace(/\s/g,"").toUpperCase();try{o=yield cadesplugin.CreateObjectAsync("CAdESCOM.Store");yield o.Open()}catch(r){alert("Failed to create CAdESCOM.Store: "+r.number);return}var nt=yield o.Certificates,l=yield nt.Find(0,c);if(yield l.Count==0){alert("Certificate not found");return}var a=yield l.Item(1),tt=document.getElementById("DataEncryptedBox1").value,it=document.getElementById("DataEncryptedBox2").value,v;v=n=="CertListBox1"?"DataEncryptedKey1":"DataEncryptedKey2";y=document.getElementById(v).value;try{FillCertInfo_Async(a,"cert_info_decr");u="";try{i=yield cadesplugin.CreateObjectAsync("cadescom.symmetricalgorithm")}catch(r){u="Failed to create cadescom.symmetricalgorithm: "+r;alert(u);throw u;}yield i.ImportKey(y,a);p=document.getElementById("DataEncryptedDiversData1").value;w=document.getElementById("DataEncryptedIV1").value;yield i.propset_DiversData(p);s=yield i.DiversifyKey();yield s.propset_IV(w);b=yield s.Decrypt(tt,1);document.getElementById("DataDecryptedBox1").innerHTML=Base64.decode(b);k=document.getElementById("DataEncryptedDiversData2").value;d=document.getElementById("DataEncryptedIV2").value;yield i.propset_DiversData(k);h=yield i.DiversifyKey();yield h.propset_IV(d);g=yield h.Decrypt(it,1);document.getElementById("DataDecryptedBox2").innerHTML=Base64.decode(g);alert("Данные расшифрованы успешно:")}catch(r){alert("Ошибка при шифровании данных:"+r);throw"Ошибка при шифровании данных:"+r;}},n)}function RetrieveCertificate_Async(){cadesplugin.async_spawn(function*(){var t,i,u,e,f;try{t=yield cadesplugin.CreateObjectAsync("X509Enrollment.CX509PrivateKey")}catch(r){alert("Failed to create X509Enrollment.CX509PrivateKey: "+cadesplugin.getLastError(r));return}yield t.propset_ProviderName("Crypto-Pro GOST R 34.10-2001 Cryptographic Service Provider");yield t.propset_ProviderType(75);yield t.propset_KeySpec(1);try{i=yield cadesplugin.CreateObjectAsync("X509Enrollment.CX509CertificateRequestPkcs10")}catch(r){alert("Failed to create X509Enrollment.CX509CertificateRequestPkcs10: "+cadesplugin.getLastError(r));return}yield i.InitializeFromPrivateKey(1,t,"");try{u=yield cadesplugin.CreateObjectAsync("X509Enrollment.CX500DistinguishedName")}catch(r){alert("Failed to create X509Enrollment.CX500DistinguishedName: "+cadesplugin.getLastError(r));return}e="Test Certificate";yield u.Encode('CN="'+e.replace(/"/g,'""')+'";');yield i.propset_Subject(u);var o=yield cadesplugin.CreateObjectAsync("X509Enrollment.CX509ExtensionKeyUsage");yield o.InitializeEncode(240);yield(yield i.X509Extensions).Add(o);try{f=yield cadesplugin.CreateObjectAsync("X509Enrollment.CX509Enrollment")}catch(r){alert("Failed to create X509Enrollment.CX509Enrollment: "+cadesplugin.getLastError(r));return}yield f.InitializeFromRequest(i);var s=yield f.CreateRequest(1),h="CertRequest="+encodeURIComponent(s)+"&Mode="+encodeURIComponent("newreq")+"&TargetStoreFlags="+encodeURIComponent("0")+"&SaveCert="+encodeURIComponent("no"),n=getXmlHttp();n.open("POST","https://www.cryptopro.ru/certsrv/certfnsh.asp",!0);n.setRequestHeader("Content-Type","application/x-www-form-urlencoded");n.onreadystatechange=function(){n.readyState==4&&n.status==200&&cadesplugin.async_spawn(function*(n){var i=n[0],t="",r,u,f,o;isIE()?(r=i.indexOf('sPKCS7 & "')+9,u=i.indexOf("& vbNewLine\r\n\r\n<\/Script>"),t=i.substring(r,u),t=t.replace(new RegExp(" & vbNewLine","g"),";"),t=t.replace(new RegExp("&","g"),"+"),t="var sPKCS7="+t+";"):(r=i.indexOf("var sPKCS7"),u=i.indexOf('sPKCS7 += ""')+13,t=i.substring(r,u));eval(t);try{f=yield cadesplugin.CreateObjectAsync("X509Enrollment.CX509Enrollment")}catch(e){alert("Failed to create X509Enrollment.CX509Enrollment: "+cadesplugin.getLastError(e));return}yield f.Initialize(1);yield f.InstallResponse(0,sPKCS7,7,"");o=document.getElementById("boxdiv").style.display="none";location.pathname.indexOf("simple")>=0?location.reload():location.pathname.indexOf("symalgo_sample.html")>=0?(FillCertList_Async("CertListBox1"),FillCertList_Async("CertListBox2")):FillCertList_Async("CertListBox")},n.responseText)};n.send(h)})}function CheckForPlugInUEC_Async(){var n=!1;cadesplugin.async_spawn(function*(){var f=yield cadesplugin.CreateObjectAsync("CAdESCOM.About"),u,t=yield f.PluginVersion,e;typeof t=="undefined"&&(t=yield f.Version);var i="1.5.1633".split("."),r=!0;if(yield t.MajorVersion==parseInt(i[0])?yield t.MinorVersion==parseInt(i[1])?yield t.BuildVersion==parseInt(i[2])?r=!0:yield t.BuildVersion<parseInt(i[2])&&(r=!1):yield t.MinorVersion<parseInt(i[1])&&(r=!1):yield t.MajorVersion<parseInt(i[0])&&(r=!1),r){document.getElementById("PluginEnabledImg").setAttribute("src","Img/green_dot.png");document.getElementById("PlugInEnabledTxt").innerHTML="Плагин загружен.";try{e=yield cadesplugin.CreateObjectAsync("CAdESCOM.UECard");u=yield e.ProviderVersion;n=!0}catch(o){u="Нет информации"}n||(document.getElementById("PluginEnabledImg").setAttribute("src","Img/yellow_dot.png"),document.getElementById("PlugInEnabledTxt").innerHTML="Плагин загружен. Не установлен УЭК CSP.")}else document.getElementById("PluginEnabledImg").setAttribute("src","Img/yellow_dot.png"),document.getElementById("PlugInEnabledTxt").innerHTML="Плагин загружен, но он не поддерживает УЭК.";document.getElementById("PlugInVersionTxt").innerHTML="Версия плагина: "+yield t.toString();document.getElementById("CSPVersionTxt").innerHTML="Версия УЭК CSP: "+yield u.toString()})}function FoundCertInStore_Async(n){return new Promise(function(t,i){cadesplugin.async_spawn(function*(t){var i,o,e,h,u,r,c;(typeof n=="undefined"||n==null)&&t[0](!1);i=yield cadesplugin.CreateObjectAsync("CAPICOM.store");i||(alert("store failed"),t[0](!1));try{yield i.Open()}catch(f){alert("Ошибка при открытии хранилища: "+cadesplugin.getLastError(f));t[0](!1)}for(o=yield i.Certificates,e=yield o.Count,e==0&&(i.Close(),t[0](!1)),h=yield n.Thumbprint,u=1;u<=e;u++){try{r=yield o.Item(u)}catch(f){alert("Ошибка при перечислении сертификатов: "+cadesplugin.getLastError(f));t[0](!1)}try{if(c=yield r.Thumbprint,c==h){var l=new Date,a=new Date(yield r.ValidToDate),v=yield r.HasPrivateKey(),s=yield r.IsValid();s=yield s.Result;l<a&&v&&s&&t[0](!0)}else continue}catch(f){alert("Ошибка при получении свойства Thumbprint: "+cadesplugin.getLastError(f));t[0](!1)}}i.Close();t[0](!1)},t,i)})}function getUECCertificate_Async(){return new Promise(function(n,t){showWaitMessage("Выполняется загрузка сертификата, это может занять несколько секунд...");cadesplugin.async_spawn(function*(n){var i,t,r;try{if(i=yield cadesplugin.CreateObjectAsync("CAdESCOM.UECard"),t=yield i.Certificate,typeof t=="undefined"){document.getElementById("cert_info1").style.display="";document.getElementById("certerror").innerHTML="Сертификат не найден или отсутствует.";throw"";}if(t==null){document.getElementById("cert_info1").style.display="";document.getElementById("certerror").innerHTML="Сертификат не найден или отсутствует.";throw"";}if(yield FoundCertInStore_Async(t))FillCertInfo_Async(t),g_oCert=t;else{document.getElementById("cert_info1").style.display="";document.getElementById("certerror").innerHTML="Сертификат не найден в хранилище MY.";throw"";}n[0]()}catch(u){r=cadesplugin.getLastError(u);"The action was cancelled by the user. (0x8010006E)"==r&&(document.getElementById("cert_info1").style.display="",document.getElementById("certerror").innerHTML="Карта не найдена или отсутствует сертификат на карте.");n[1]()}},n,t)})}function createSignature_Async(){return new Promise(function(n,t){cadesplugin.async_spawn(function*(n){var i="",t,u,r,f;try{t=yield cadesplugin.CreateObjectAsync("CAdESCOM.CPSigner");yield t.propset_Certificate(g_oCert);u=1;yield t.propset_Options(u);r=yield cadesplugin.CreateObjectAsync("CAdESCOM.CadesSignedData");yield r.propset_Content("DataToSign");f=1;i=yield r.SignCades(t,f);n[0](i)}catch(e){showErrorMessage("Ошибка: Не удалось создать подпись. Код ошибки: "+cadesplugin.getLastError(e));n[1]("")}n[0](i)},n,t)})}function verifyCert_Async(){if(!g_oCert){removeWaitMessage();return}createSignature_Async().then(function(n){document.getElementById("SignatureTxtBox").innerHTML=n;var t=document.getElementsByName("SignatureTitle");t[0].innerHTML="Подпись сформирована успешно:";removeWaitMessage()},function(){removeWaitMessage()})}function isIE(){return"Microsoft Internet Explorer"==navigator.appName||navigator.userAgent.match(/Trident\/./i)}CertificateAdjuster.prototype.extract=function(n,t){var i,r;return certName="",i=n.indexOf(t),i>=0&&(r=n.indexOf(", ",i),certName=r<0?n.substr(i):n.substr(i,r-i)),certName};CertificateAdjuster.prototype.Print2Digit=function(n){return n<10?"0"+n:n};CertificateAdjuster.prototype.GetCertDate=function(n){var t=new Date(n);return this.Print2Digit(t.getUTCDate())+"."+this.Print2Digit(t.getMonth()+1)+"."+t.getFullYear()+" "+this.Print2Digit(t.getUTCHours())+":"+this.Print2Digit(t.getUTCMinutes())+":"+this.Print2Digit(t.getUTCSeconds())};CertificateAdjuster.prototype.GetCertName=function(n){return this.extract(n,"CN=")};CertificateAdjuster.prototype.GetIssuer=function(n){return this.extract(n,"CN=")};CertificateAdjuster.prototype.GetCertInfoString=function(n,t){return this.extract(n,"CN=")+"; Выдан: "+this.GetCertDate(t)};async_resolve();